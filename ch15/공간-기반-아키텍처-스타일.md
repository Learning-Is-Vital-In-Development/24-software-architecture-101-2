## 공간 기반 아키텍처 스타일

높은 확장성, 탄력성, 동시성 및 이와 같은 문제를 해결하기 위해 설계된 아키텍처 스타일이다.
동시 유저 수가 매우 가변적이여서 예측조차 곤란한 애플리케이션에서도 유용하다

극단적이고 가변적인 확장성 문제는 데이터베이스를 확장하거나. 확장성이 떨어지는 아키텍처에 맞게 캐시 기술을 적용하는 것보다 아키텍처적으로 해결하는 것이 더 낫다.

### 토폴로지

공간 기반 아키텍처 명칭은 튜플 공간에서 유래됬다.
튜플 공간은 공유 메모리를 통해 통신하는 다중 병렬 프로세서를 사용하는 기술이다.

- 시스템에서 동기 제약조건인 중앙 데이터베이스를 없애는 대신, 복제된 인메모리 데이터 그리드를 활용하면 확장성, 탄력성, 성능을 높일 수 있다.
- 애플리케이션 데이터는 메모리에 둔 상태로 모든 활성 처리 장치들이 데이터를 복제한다.
- 처리 장치는 데이터를 업데이트할 때 퍼시스턴스뷰에 메세지를 보내는 식으로 데이터베이스에 데이터를 비동기 전송한다.

컴포넌트 구성

- 애플리케이션 코드가 구현된 처리 장치
- 처리 장치를 관리/조정하는 가상 미들웨어
- 업데이트된 데이터를 데이터베이스에 비동기 전송하는 데이터 펌프
- 데이터 펌프에서 데이터를 받아 업데이트를 수행하는 데이터 라이더
- 처리 장치가 시작되자마자 데이터베이스의 데이터를 읽어 전달하는 데이터 리더

### 처리장치

- 처리 장치는 애플리케이션 로직을 갖고있고, 웹기반 컴포넌트, 백엔드 비즈니스 로직이 포함되나 애플리케이션 종류마다 내용물은 달라진다.
- 작은 웹기반 애플리케이션은 단일 처리 장치에 배포할 수 있지만, 대규모 애플리케이션은 기능별로 여러 처리 장치에 나누어 배포해야 한다.
- 애플리케이션 로직 외에도 헤이즐캐스트, 아파치 이그나이트, 오라클 코히어런스등의 제품에 있는 인메모리 데이터 그리드 및 복제 엔진도 처리장치에 포함된다.

### 가상 미들웨어

가상 미들웨어는 아키텍처 내부에서 데이터 동기화 및 요청 처리의 다양한 부분을 제어하는 인프라를 담당한다.

- 메시징 그리드
- 데이터 그리드
- 처리 그리드
- 배포 관리자

메시지 그리드

- 입력 요청과 세션 상태를 관리한다.
- 요청이 유입되면 메시징 그리드는 어느 활성 처리 장치가 요청을 받아 처리할지 결정하여 처리 장치로 요청을 전달
- 복잡도는 단순 라운드 로빈 알고리즘 부터 처리 장치가 요청 처리 상태를 추적하는 복잡한 알고리즘 까지 사용가능
- 보통 부하 분산이 가능한 일반 웹 서버로 구현

데이터 그리드

- 공간 기반 아키텍처 스타일에서 가장 필수적인 컴포넌트이다.
- 거의 대부분 복제 캐시로서 처리 장치에만 구현
- 외부 컨트롤러가 필요한 복제,분산 캐시를 사용할 경우, 데이터 그리드는 가상 미들웨어 내부의 데이터 그리드 컴포넌트와 처리 장치 모두에 위치한다.
- 모든 처리 장치에 전달할수 있기 때문에 각 처리 장치는 자신의 인메모리 데이터 그리드에 정확히 동일한 데이터를 갖고 있다.
- 데이터 동기화는 비동기 방식으로 대개 100밀리초 미만으로 이뤄진다.
- 데이터는 처리 장치 내부에서 복제되므로 데이터베이스에서 데이터를 읽지 않아도 서비스 인스턴스의 기동/중지가 가능하다. 단, 이름을 부여한 복제 캐시를 가진 인스턴스가 하나 이상 필요하다.

처리 그리드

- 가상 미들웨어에서 필수 컴포넌트는 아니지만 다수의 처리 장치가 단일 비즈니스 요청을 처리할 경우 요청 처리를 오케스트레이트하는 일을 한다.
- 다른 처리 장치 사이에 조정이 필요한 요청이 들어오면 처리 그리드가 두 처리 장치 사이에서 요청을 중재/조정한다.

배포 관리자

- 부하 조건에 따라 처리 장치 인스턴스를 동적으로 시작/종료하는 컴포넌트
- 응답 시간, 유저 부하를 계속 모니터링하다가 부하가 증가하면 새로운 처리 장치를 기동하고 반대로 감소하면 기존 처리 장치를 종료한다.
- 확장성 요구사항을 구현하는 데 필요한 컴포넌트

### 데이터 펌프

- 데이터를 다른 프로세서에 보내 데이터베이스를 업데이트하는 장치
- 처리 장치가 데이터를 데이터베이스에서 직접 읽고 쓰지 않기 떄문에 데이터 펌프가 반드시 필요하다.
- 항상 비동기로 동작하면서 메모리 캐시와 데이터베이스의 최종 일관성을 실현
- 처리 장치 인스턴스가 요청을 받고 캐시를 업데이트하면 처리 장치가 그 업데이트의 소유자가 되므로 데이터베이스 역시 데이터 펌프를 통해 최종 일관적으로 업데이트되도록 업데이트를 전송한다.
- 대개 메시징 기법으로 구현
  - 비동기 통신을 지원하고 전달을 보장하며 큐를 통해 메시지 순서도 유지
  - 메시징을 이용하면 처리 장치와 데이터 라이터를 분리할 수 있기 때문에 데이터 라이터를 사용할 수 없는 경우에도 처리 장치에서 무중단 처리가 가능하다.

### 데이터 라이터

- 데이터 펌프에서 메시지를 받아 그에 맞게 데이터베이스를 업데이트 하는 컴포넌트이다.
- 서비스나 애플리케이션, 데이터 허브로 구현할수 있다.
- 도메인 기반의 데이터 라이터는 데이터 펌프 수와 무관하게 특정 도메인의 전체 업데이트를 처리하는 데 필요한 모든 데이터베이스 로직을 갖고 있다.

### 데이터 리더

- 데이터베이스에서 데이터를 읽어 리버스 데이터 펌프를 통해 처리 장치로 실어 나르는 컴포넌트 이다.
- 데이터 리더가 작동하는 경우
  - 동일한 이름의 캐시를 가진 모든 처리 장치 인스턴스가 실패하는 경우
  - 동일한 이름의 캐시 안에서 모든 처리 장치를 재배포 하는 경우
  - 복제 캐시에 들어있지 않은 아카이브 데이터를 조회하는 경우
- 데이터 라이터와 데이터 리더는 본질적으로 데이터 추상 레이어를 형성한다.
- 두 레이어의 차이점은 처리 장치가 데이터베이스의 테이블 구조를 얼마나 자세히 알고 있는가 이다.
- 데이터 엑세스 레이어는 처리 장치가 데이터 베이스의 하부 데이터 구조와 커플링되어 있으므로 데이터리더/라이터만 사용해서 간접적으로 데이터베이스에 엑세스한다.
- 데이터 추상 레이어는 처리 장치가 별도의 계약에 의해 하부 데이터베이스의 테이블 구조와 분리되어 있다.
- 일반적으로 데이터 추상 레이어 모델에 기반하므로 처리 장치마다 복제 캐시 스키마는 하부 데이터베이스의 테이블 구조와 다를 수 있고, 따라서 처리 장치에 영향을 미치지 않고서도 데이터베이스 증분 변경이 가능하며, 데이터 리더/라이트에 이미 변환 로직이 포함되어 있기 때문에 증분 변경이 더 용이하다.

### 데이터 충돌

- 이름이 동일한 캐시가 포함된 서비스 인스턴스에 시시각각 업데이트가 일어나는 active/active 상태에서 복제 캐시를 사용하면 복제 레이턴시 떄문에 데이터 충돌이 발생할수 있따.
- 테이터 충돌 발생 빈도는 동일한 캐시를 포한한 처리 장치 인스턴스 수, 캐시 업데이트율, 캐시 크기, 캐시 제품의 복제 레이턴시 등 여러 팩터가 영향을 미친다.

### 클라우드 대 온프레미스 구현

- 공간 기반 아키텍처는 클라우드 기반의 환경이나 온프레미스에 배포할 수 있다.
- 물리 데이터베이스와 데이터를 온프레미스에 그대로 둔 상태로, 클라우드 기반의 매니지드 환경에서 처리 장치와 가상 미들웨어를 통해 애플리케이션을 배포하는 하이브리드 클라우드가 가능한것이 장점이다.

### 복제 캐시 대 분산 캐시

- 캐시 기술을 활용하여 애플리케이션 트랜잭션을 처리하고 데이터베이스에 직접 읽기/쓰기를 할 필요가 없어서 확장성,탄력성, 성능이 우수하다.
- 대부분 복제 캐시를 사용하지만 분산 캐시도 사용할수 있다.
- 복제 캐시를 사용할 경우, 각 처리 장치는 이름이 동일한 캐시를 사용하는 모든 처리 장치 간에 동기화 되는 자체 인메모리 데이터 그리드를 갖고 있따.
- 복제 캐시의 경우 내부 메모리 캐시가 100MB를 초과하면 각 처리 장치 마다 메모리를 점유하기 때문에 탄력성, 확장성에 문제가 발생할수 있다.
- 분산 캐시의 경우 높은 수준의 데이터 일관성을 보장하지만, 캐시 데이터를 원격으로 가져와야 하므로 복제 캐시보다 성능이 낮고 시스템 전체 레이턴시가 증가한다.
- 캐시 크기가 100MB 보다 작고 캐시 업데이트율이 낮은 편이라서 캐시 제품의 복제 엔진이 캐시 업데이트를 충분히 따라올수 있따면, 복제, 분산의 선택은 데이터 일관성이냐 성능/내고장성이냐의 문제이다.

### 니어 캐시

- 분산 캐시와 인메모리 데이터 그리드를 접합한 일종의 하이브리드 캐시 모델이다.
- 분산 캐시는 풀 백킹 캐시, 각 처리 장치에 포함된 인메모리 데이터 그리드는 프런트 캐시라고 한다.
- 프런트 캐시는 항상 풀 백킹 캐시보다 작은 서브세트를 담고 있고, 방출 정책을 통해 옛 항목을 삭제한 다음 최근 항목을 추가한다.
